<div class="cities-map">

  {{#leaflet-map  onMove    = (action 'updateNewPoint'  ) 
                  onMoveend = (action 'currentMapState' ) 
                  onLoad    = (action 'initMap'         ) 
                  zoom      = zoom 
                  lat       = lat
                  lng       = lng
                  maxZoom   = maxZoom}}
    {{#if (eq basemap 'default')}}
      {{tile-layer  maxNativeZoom=maxNativeZoom
                    maxZoom=maxZoom 
                    url="http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png" }}
    {{/if}}
    {{#if (eq basemap 'satellite')}}
      {{tile-layer  maxNativeZoom=maxNativeZoom
                    maxZoom=maxZoom  
                    url='https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' }}
    {{/if}}

    {{#each model as |city|}}
      {{image-layer pane='extrusions' imageUrl=city.imageOverlay bounds=city.imageOverlayBBox opacity=0.9}}
    {{/each}}

    {{#if showFeatures}}
      {{#each visibleFeatures as |feature|}}
        {{#if (and feature.latitude feature.id)}}
          {{related-investments-icon feature=feature linkTo=(transition-to)}}
        {{/if}}
      {{/each}}
    {{/if}}

    {{#if showParcels}}
      {{#each visibleParcels as |parcel|}}
        {{#if parcel.geom}}
          {{#map-popup lat=parcel.latitude lng=parcel.longitude as |popup|}}
            <strong>{{parcel.ownership_type}}</strong>
            <img class="ui small image" src={{parcel.splash}}/>
            <strong>{{parcel.address}}</strong>
            {{geojson-layer geoJSON=parcel.geojson 
                            style=parcelsChoroplethMapping 
                            onClick=(transition-to 'cities.city.parcels' parcel.id)
                            onMouseover=(action popup.onMouseover)
                            onMouseout=(action popup.onMouseout)
                            pane='parcels'}}
            {{#if parcel.isSelected}}
              {{marker-layer lat=parcel.latitude lng=parcel.longitude opacity=1}}
            {{/if}}
          {{/map-popup}}
        {{/if}}
      {{/each}}
    {{/if}}

    {{#if currentCity.isPlottingPoint}}
      {{marker-layer  lat=currentCity.newPointLatitude 
                      lng=currentCity.newPointLongitude
                      icon=(icon iconUrl='/images/add-data-pin.png' iconAnchor=(array 30 76) iconSize=(array 59 76))}}
    {{/if}}

  {{/leaflet-map}}

  {{basemap-menu  x=layerPointx
                  y=layerPointy
                  z=layerPointz
                  basemap=basemap}}
</div>